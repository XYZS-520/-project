<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <link rel="shortcut icon" href="../favicon.ico" type="image/x.icon">
    <link rel="stylesheet" href="../css/public.css">
    <link rel="stylesheet" href="../css/common.css">
    <link rel="stylesheet" href="../css/main.css">
    <link rel="stylesheet" href="../css/identical.css">
    <link rel="stylesheet" href="xianhuacss/shopcar.css">
</head>

<body>

    <div id="topAll"></div>

    <section class="car ">
        <h2 class="wrapper"><a href="shoplist.html">继续购物</a></h2>
        <table class="carall wrapper">
            <thead class="cartitle">
                <tr>
                    <th>全选<input type="radio" class="choose"></th>
                    <th>图片</th>
                    <th>名字</th>
                    <th>价格</th>
                    <th>数量</th>
                    <th>总价</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody class="carmain">
                <tr>
                    <td>购物车暂时为空，请<a href="shoplist.html">继续购物</a></td>
                </tr>
                <!-- <tr>
                    <td><input type="radio"></td>
                    <td><img src="" alt=""></td>
                    <td  class="teshude"></td>
                    <td></td>
                    <td><input class="sumgb" type="number" min="1"></td>
                    <td><span>删除</span></td>
                    <td></td>
                </tr> -->

            </tbody>
            
        </table>
       <div class="wrapper">
            <div class="carmain-b " style="position:relative;background-color: #eee;width:100%;height:60px">
                <div>
                    <i style="display:block;font-size: 20px;position: absolute;right: 60px;top: 9px;">结算
                        <input type="button" value="去支付"
                            style="width:50px;line-height:24px;text-align:center;color:#fff;border:none;border-radius:16% 16% 16% 16%;margin-left:90px;background-color:#f00;">
                    </i>
                </div>
            </div>
        </div>

    </section>

    <div id="footerAll"></div>

</body>
<script src="js/ajax.js"></script>
<script src="js/cookie.js"></script>
<script src="js/jquery.js"></script>
<script>
    class Car {
        constructor(options) {
            this.url = options.url;
            this.tbody = options.tbody;
            // 读取商品信息
            this.read();

            this.weiEvent();
        }

        read() {
            var _this = this;
            ajaxGet(this.url, function (e) {
                // console.log(e);
                _this.e = JSON.parse(e);
                // console.log(_this.e);
                // 读取cookie
                _this.getCookie();
            })
        }
        getCookie() {
            // 判断是否有cookie 
            this.goods = getCookie("goods") ? JSON.parse(getCookie("goods")) : [];
            // console.log(this.goods);    
            this.display();
        }

        // 以cookie的id与商品goodId比较 相同时渲染页面数据拼接到页面中
        display() {
            var str = "";

            for (var i = 0; i < this.e.length; i++) {
                for (var j = 0; j < this.goods.length; j++) {
                    if (this.e[i].goodsId === this.goods[j].id) {
                        str += `<tr index="${this.goods[j].id}">
                                    <td><input type="radio"></td>
                                    <td><img src="${this.e[i].img}" alt=""></td>
                                    <td class="teshude">${this.e[i].name}</td>
                                    <td>${this.e[i].price}</td>
                                    <td><input class="sumgb" type="number" min="1" value="${this.goods[j].num}"></td>
                                    <td>${(this.e[i].price) * (this.goods[j].num)}</td>
                                    <td><span style="background-color: #f00;width: 43px;line-height: 24px;display: block;vertical-align: middle;text-align: center;color: #fff;border-radius:16% 16% 16% 16%;">删除</span></td>
                                </tr>
                                 `;
                    }
                }
            }
            this.tbody.innerHTML = str;
        }
        weiEvent() {
            var _this = this;
            this.tbody.addEventListener("click", function (e) {
                if (e.target.tagName == "SPAN") {
                    _this.id = e.target.parentNode.parentNode.getAttribute("index");
                    e.target.parentNode.parentNode.remove();
                    _this.delCookie();
                }
            })
            this.tbody.addEventListener("input", function (e) {
                if (e.target.tagName == "INPUT") {
                    _this.id = e.target.parentNode.parentNode.getAttribute("index");
                    _this.value = e.target.value;
                    _this.changeCookie();
                }
            })
        }
        delCookie() {
            for (var i = 0; i < this.goods.length; i++) {
                if (this.goods[i].id === this.id) {
                    this.goods.splice(i, 1);
                }
            }
            setCookie("goods", JSON.stringify(this.goods));
        }
        changeCookie() {
            for (var i = 0; i < this.goods.length; i++) {
                if (this.goods[i].id === this.id) {
                    this.goods[i].num = this.value;
                }
            }
            setCookie("goods", JSON.stringify(this.goods));
        }

    }
    new Car({
        url: "http://localhost/1023-server/floors/xianhua/json/shopde.json",
        tbody: document.querySelector("tbody")
    })

</script>

<script>
    $(function () {
        $("#topAll").load("http://localhost/1023-server/floors/xianhua/html-header/topAll.html .topAll");
        $("#footerAll").load("http://localhost/1023-server/floors/xianhua/html-header/footer.html .footerAll");
    })
</script>

</html>